<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Prédiction du prix du kWh TTC au TRVE résidentiel en 2026 <br> Avec et sans ARENH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{
      margin:0; background:#fff;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      display:flex; justify-content:center; padding:40px 16px;
    }
    .chart-wrapper{ background:transparent; border-radius:0; box-shadow:none; padding:0; max-width:940px; width:100%; }
    h1{ margin:0 0 14px; text-align:center; font-size:22px; font-weight:600; color:#0b0f19; }
    .legend-note{ margin:2px 0 12px; text-align:center; color:#64748b; font-size:13px; }
    canvas{ width:100% !important; height:auto !important; display:block; background:transparent !important; }
  </style>
</head>
<body>
  <div class="chart-wrapper">
    <h1>Historique des prédictions du prix du kWh TTC au TRVE résidentiel en 2026 - Avec et sans ARENH</h1>
    <canvas id="chart" aria-label="Comparatif ARENH" role="img"></canvas>
  </div>

  <script>
    const jsonUrl = "https://raw.githubusercontent.com/FEPPN/Graph/main/data.json";

    // util: tolère plusieurs schémas de clés
    const pick = (obj, keys) => {
      for (const k of keys) if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
      return undefined;
    };

    const toFr = (iso) => {
      if (typeof iso !== "string") return String(iso ?? "");
      const [y, m, d] = iso.split("-");
      return (y && m && d) ? `${d}/${m}/${y}` : new Date(iso).toLocaleDateString("fr-FR");
    };

    fetch(jsonUrl + "?v=" + Date.now(), { cache: "no-store" })
      .then(r => { if(!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
      .then(rows => {
        const labels = [];
        const withA = [];
        const withoutA = [];

        rows.forEach(r => {
          const dateIso  = pick(r, ["Date","date","dateISO"]);
          const vWith    = Number(pick(r, ["withARENH","with_arenh","wARENH"]));
          const vWithout = Number(pick(r, ["withoutARENH","without_arenh","woARENH"]));
          if (!dateIso || Number.isNaN(vWith) || Number.isNaN(vWithout)) return;

          labels.push(toFr(String(dateIso)));
          withA.push(vWith);
          withoutA.push(vWithout);
        });

        const ctx = document.getElementById("chart").getContext("2d");

        // dégradés
        const gWith = ctx.createLinearGradient(0,0,0,300);
        gWith.addColorStop(0,"rgba(90,82,255,0.22)");
        gWith.addColorStop(1,"rgba(90,82,255,0.00)");

        const gWithout = ctx.createLinearGradient(0,0,0,300);
        gWithout.addColorStop(0,"rgba(15,196,178,0.22)");
        gWithout.addColorStop(1,"rgba(15,196,178,0.00)");

        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              { label:"Avec ARENH",   data:withA,    borderColor:"#5a52ff", backgroundColor:gWith,    borderWidth:1.6, pointRadius:0, spanGaps:true, tension:0.28, fill:true },
              { label:"Sans ARENH",   data:withoutA, borderColor:"#0fc4b2", backgroundColor:gWithout, borderWidth:1.6, pointRadius:0, spanGaps:true, tension:0.28, fill:true }
            ]
          },
          options: {
            responsive:true,
            interaction:{ mode:"nearest", intersect:false },
            plugins:{
              legend:{ position:"bottom", labels:{ color:"#1f2937", font:{ size:13, weight:"600" } } },
              tooltip:{
                backgroundColor:"#fff", borderColor:"#e5e7eb", borderWidth:1,
                titleColor:"#111827", bodyColor:"#4b5563",
                titleFont:{ weight:"700" }, bodyFont:{ weight:"500" },
                padding:10, cornerRadius:10,
                callbacks:{ label:(ctx)=>`${ctx.dataset.label} : ${ctx.parsed.y?.toFixed(4)} € / kWh TTC` }
              }
            },
            scales:{
              y:{
                ticks:{ color:"#6b7280", callback:v=>`${Number(v).toFixed(3)} €` },
                grid:{ color:"rgba(0,0,0,0.06)" },
                border:{ display:false }
              },
              x: {
  ticks: {
    color: "#6b7280",
    autoSkip: true,
    maxTicksLimit: 8,
    maxRotation: 45,  // rotation maximale (en degrés)
  },
  grid: { display: false },
  border: { display: false }
}
            }
          }
        });
      })
      .catch(err => {
        console.error(err);
        document.querySelector(".chart-wrapper").insertAdjacentHTML(
          "beforeend",
          `<p style="margin-top:10px;color:#ef4444;text-align:center">Erreur de chargement des données.</p>`
        );
      });
  </script>
</body>
</html>
